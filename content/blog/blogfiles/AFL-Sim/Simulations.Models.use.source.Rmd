---
title: "AFL Simulation Stimulation: Part 1"
author: "Joshua White"
date: "26 March 2019"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("simul2.R")
source("normdistsim.R")
source("tanhv2018(trained on 2018).R")
```

Recently I was, as I am (unfortunately) rather wont to do, aimlessly watching YouTube videos when I came across these [two](https://www.youtube.com/watch?v=Vv9wpQIGZDw) [videos](https://www.youtube.com/watch?v=Zs2M7gWSbTg) by Numberphile. Here, the authors discuss their attempts at modelling and simulating seasons of the English Premier League. 

As an avid [AFL](https://en.wikipedia.org/wiki/Australian_Football_League) fan, and with the upcoming season fast approaching (edit, now underway, [carn](https://www.urbandictionary.com/define.php?term=carn) [the cats!](https://www.afl.com.au/news/2019-03-22/match-report-collingwood-v-geelong)), why not try to apply these methods to the AFL season.  This post will be the first of a three part series. In part 1, I will discuss the models and compare their results to the actual data from the 2018 season. Part 2 will apply the models to the 2019 season. And part 3 will go through the details and show the code.  

## The Models

###Poisson Distributed Team Scores
Okay, lets discuss the model. Basically, each team's score in every game is modeled as a random drawing from a Poisson distribution --- i.e. $P(k) = e^{-\lambda} \frac{\lambda^k}{k!}$, where k is the number of points scored. A Poisson distribution is great for simple modelling because it only requires estimating one parameter, $\lambda$. On the other hand, it isn't exactly suited to the AFL context because the model assumes that all events (in this case, scoring a point) occur independently. In AFL, a goal in AFL is worth 6 points, violating this assumption.  

In any case, let's press on with that in mind. We calculate $\lambda$ for each game, based on the points scored for and against, at home and away, for each team in 2018:

$\lambda_{home team} =$ League Average points scored at home $\times$ home team attack strength at home $\times$ awayteam attack strength away

$\lambda_{away team} =$ League Average points scored away $\times$ away team attack strength away $\times$ hometeam defense strength at home

As you can see, the model takes into account the general home advantage as well as each particular team's attack and defensive strengths at home and away. The strength parameters refereed to above are simply the averages for that particular team, relative to the league-wide average. 

###Normally Distributed team scores
This model is a simple extension to the Poisson-based model above, and should be superior to it because: 

1. There is no assumption of independence, and 
2. It has an extra parameter to capture differences among teams in the variance of their defense and attack strength. 

Here, it is assumed that team scores are normally distributed around $\lambda$ as defined above, with a standard deviation calculated as the pooled standard deviation of that teams 'for' scores standard deviation, and the opponents 'against' scores standard deviation:
$$Points_{teamA} \sim \mathcal{N}(\mu=\lambda,\,\sigma = \sigma_p)\,$$ 
where: <br>
$$\sigma_{p}=\frac{\sigma_{teamAfor} + \sigma_{teamBagainst}}{2}$$

###Rankings model: tanh
This model simply relies on the ordinal data of last years final Ladder: Carlton, the wooden spoon winners (i.e. the last placeholders, out of 18 teams) get a ranking of 1, and Richmond, who finished on top of the table get a ranking of 18. Then, with this information, the probability of team A winning is modelled as follows:

$$P(A\>wins)=\frac{tanh(\frac{a-b}{w})+1}{2} - \frac{d}{2}$$
where,<br>
A = home team <br>
a = home team ranking <br> 
b = away team ranking <br>
w = weighting parameter (the higher the number the less weight placed on the rankings) <br>
x = draw rate, to allow for possibility of draws. 

This draw rate was based on the likelihood of drawing a game. Based on this data, which showed no increase likelihood of drawing based on similarity in rankings, is invariant to team rankings and is always set as $\frac{7}{990} \approx 0.007$ (which is the number of draws over the number of games in the last 5 years).

Finally, the probability of B winning is calculated as what remains as follows: 

$$P(B\>wins)= 1 - P(A\>wins) - \frac{d}{2}$$

So lets calculate the lambda for each home and away pairing that will occur in the AFL season 2019. Each of the 18 teams plays only 22 games, so each team does not get to play each other twice. 
Before we can calculate lambda we need to calculate the scaling parameters discussed above, what we will call attack strength (for home and away) and defencestrength (for home and away)


## The Data

```{r data}
pointstidy
fixture2019
```


##Results

###Poisson model
```{r poisresults}
Finalsimtablepois

```

###Normal model
```{r normresults}
Finalsimtablenorm

```

###Tanh model

```{r tanhresults}
Finalsimlist[[10]] 
Finalsimlist[[20]]
Finalsimlist[[50]]
Finalsimlist[[100]]
Finalsimlist[[1000]]
Finalsimlist[[10000]]
Finalsimlist[[99999]]

lapply(Finalsimlist, "[[", c(10, 20, 50, 100, 1000, 10000, 99999))
```


